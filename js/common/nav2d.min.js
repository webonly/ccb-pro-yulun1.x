var NAV2D=NAV2D||{REVISION:"0.3.0"};NAV2D.ImageMapClientNav=function(a){var b=this;a=a||{},this.ros=a.ros;var c=a.topic||"/map_metadata",d=a.image;this.serverName=a.serverName||"/move_base",this.actionName=a.actionName||"move_base_msgs/MoveBaseAction",this.rootObject=a.rootObject||new createjs.Container,this.viewer=a.viewer,this.withOrientation=a.withOrientation||!1,this.navigator=null;var e=new ROS2D.ImageMapClient({ros:this.ros,rootObject:this.rootObject,topic:c,image:d});e.on("change",function(){b.navigator=new NAV2D.Navigator({ros:b.ros,serverName:b.serverName,actionName:b.actionName,rootObject:b.rootObject,withOrientation:b.withOrientation}),b.viewer.scaleToDimensions(e.currentImage.width,e.currentImage.height),b.viewer.shift(e.currentImage.pose.position.x,e.currentImage.pose.position.y)})};var robotMarker_Visible=!0;NAV2D.Navigator=function(a){function h(a){var c=new ROSLIB.Goal({actionClient:g,goalMessage:{target_pose:{header:{frame_id:"/map"},pose:a}}});c.send();var d=new ROS2D.NavigationArrow({size:15,strokeSize:1,fillColor:createjs.Graphics.getRGB(255,64,128,.66),pulse:!0});d.x=a.position.x,d.y=-a.position.y,d.rotation=j.rosQuaternionToGlobalTheta(a.orientation),d.scaleX=1/j.scaleX,d.scaleY=1/j.scaleY,b.rootObject.addChild(d),c.on("result",function(){b.rootObject.removeChild(d)})}function i(a){var b=new ROSLIB.Topic({ros:c,name:"/initialpose",messageType:"geometry_msgs/PoseWithCovarianceStamped"}),d=new ROSLIB.Message({header:{frame_id:"/map"},pose:{pose:a}});b.publish(d)}var b=this;a=a||{};var c=a.ros,d=a.serverName||"/move_base",e=a.actionName||"move_base_msgs/MoveBaseAction",f=a.withOrientation||!1;this.rootObject=a.rootObject||new createjs.Container;var j,g=new ROSLIB.ActionClient({ros:c,actionName:e,serverName:d});j=b.rootObject instanceof createjs.Stage?b.rootObject:b.rootObject.getStage();var k=new ROS2D.NavigationArrow({size:25,strokeSize:1,fillColor:createjs.Graphics.getRGB(255,128,0,.66),pulse:!0});k.visible=!1,this.rootObject.addChild(k);var l=!1,m=this.rootObject,n=new ROSLIB.Topic({ros:c,name:"/robot_pose",messageType:"geometry_msgs/Pose",throttle_rate:100});if(n.subscribe(function(a){k.x=a.position.x,k.y=-a.position.y,l||(k.scaleX=1/j.scaleX,k.scaleY=1/j.scaleY,l=!0),k.rotation=j.rosQuaternionToGlobalTheta(a.orientation),robotMarker_Visible?(k.visible=!0,m.addChild(k)):(k.visible=!1,m.removeChild(k))}),f===!1)this.rootObject.addEventListener("dblclick",function(a){var b=j.globalToRos(a.stageX,a.stageY),c=new ROSLIB.Pose({position:new ROSLIB.Vector3(b)});"goal"==action?h(c):"pose"==action&&i(c)});else{var o=null,p=null,q=0,r=0,s=null,t=!1,u=0,v=0,w=function(a,c){if("down"===c)o=j.globalToRos(a.stageX,a.stageY),p=new ROSLIB.Vector3(o),t=!0;else if("move"===c){if(b.rootObject.removeChild(s),t===!0){var d=j.globalToRos(a.stageX,a.stageY),e=new ROSLIB.Vector3(d);s=new ROS2D.NavigationArrow({size:25,strokeSize:1,fillColor:createjs.Graphics.getRGB(0,255,0,.66),pulse:!1}),u=e.x-p.x,v=e.y-p.y,q=Math.atan2(u,v),r=q*(180/Math.PI),r>=0&&180>=r?r+=270:r-=90,s.x=p.x,s.y=-p.y,s.rotation=r,s.scaleX=1/j.scaleX,s.scaleY=1/j.scaleY,b.rootObject.addChild(s)}}else if(t){t=!1;var f=j.globalToRos(a.stageX,a.stageY),g=new ROSLIB.Vector3(f);u=g.x-p.x,v=g.y-p.y,q=Math.atan2(u,v),q>=0&&q<=Math.PI?q+=3*Math.PI/2:q-=Math.PI/2;var k=Math.sin(-q/2),l=Math.cos(-q/2),m=new ROSLIB.Quaternion({x:0,y:0,z:k,w:l}),n=new ROSLIB.Pose({position:p,orientation:m});"goal"==action?h(n):"pose"==action&&i(n)}};this.rootObject.addEventListener("stagemousedown",function(a){w(a,"down")}),this.rootObject.addEventListener("stagemousemove",function(a){w(a,"move")}),this.rootObject.addEventListener("stagemouseup",function(a){w(a,"up")})}},NAV2D.OccupancyGridClientNav=function(a){var b=this;a=a||{},this.ros=a.ros;var c=a.topic||"/map",d=a.continuous;this.serverName=a.serverName||"/move_base",this.actionName=a.actionName||"move_base_msgs/MoveBaseAction",this.rootObject=a.rootObject||new createjs.Container,this.viewer=a.viewer,this.withOrientation=a.withOrientation||!1,this.navigator=null;var e=new ROS2D.OccupancyGridClient({ros:this.ros,rootObject:this.rootObject,continuous:d,topic:c});e.on("change",function(){b.navigator=new NAV2D.Navigator({ros:b.ros,serverName:b.serverName,actionName:b.actionName,rootObject:b.rootObject,withOrientation:b.withOrientation}),b.viewer.scaleToDimensions(e.currentGrid.width,e.currentGrid.height),b.viewer.shift(e.currentGrid.pose.position.x,e.currentGrid.pose.position.y)})};